<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Escape Chase - 3D Game</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        canvas { display: block; }
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #0f0;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 0 10px #0f0;
            font-family: monospace;
            z-index: 100;
        }
        #mission {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #0f0;
            font-size: 14px;
            text-shadow: 0 0 10px #0f0;
            font-family: monospace;
            max-width: 300px;
        }
        #cinematic {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s;
        }
        #cinematicText {
            color: #fff;
            font-size: 24px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="cinematic">
        <div id="cinematicText">Bank Escape...</div>
    </div>
    <div id="hud">
        <div>Speed: <span id="speed">0</span> MPH</div>
        <div>Health: <span id="health">100</span>%</div>
        <div>Fuel: <span id="fuel">100</span>%</div>
        <div>Wanted: <span id="wanted">⭐</span></div>
    </div>
    <div id="mission">
        <div id="missionText">Starting cinematic...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ========== GAME STATE ==========
        const gameState = {
            speed: 0,
            health: 100,
            fuel: 100,
            wanted: 0,
            maxSpeed: 260,
            missionPhase: 0, // 0=cinematic, 1=escape bank, 2=highway, 3=free roam
            isPlayerMoving: false,
            cameraMode: 0, // 0=cockpit, 1=hood, 2=chase, 3=cinematic
            dayNightCycle: 0, // 0=day, 1=night
            timeOfDay: 0,
            policePresence: [],
            traffic: [],
            input: { w: false, a: false, s: false, d: false }
        };

        // ========== SCENE SETUP ==========
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFShadowShadowMap;
        document.body.appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffffff, 1.0);
        sunLight.position.set(500, 300, 500);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 2048;
        sunLight.shadow.mapSize.height = 2048;
        scene.add(sunLight);

        // Background sky
        const skyGeometry = new THREE.SphereGeometry(4000, 32, 32);
        const skyMaterial = new THREE.MeshBasicMaterial({ color: 0x87ceeb, side: THREE.BackSide });
        const sky = new THREE.Mesh(skyGeometry, skyMaterial);
        scene.add(sky);

        // ========== PLAYER CAR ==========
        const playerCar = {
            position: new THREE.Vector3(0, 1, 0),
            rotation: 0,
            velocity: new THREE.Vector3(0, 0, 0),
            acceleration: 0,
            mesh: null,
            wheelRotation: 0,
            steerAngle: 0
        };

        function createPlayerCar() {
            const carGroup = new THREE.Group();
            
            // Body
            const bodyGeom = new THREE.BoxGeometry(2, 1.2, 4.5);
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0xff0000, metalness: 0.7, roughness: 0.2 });
            const body = new THREE.Mesh(bodyGeom, bodyMat);
            body.position.y = 0.6;
            body.castShadow = true;
            body.receiveShadow = true;
            carGroup.add(body);

            // Windows
            const windowGeom = new THREE.BoxGeometry(1.8, 0.8, 1.5);
            const windowMat = new THREE.MeshStandardMaterial({ color: 0x4488ff, metalness: 0.9, roughness: 0.1, transparent: true, opacity: 0.6 });
            const window1 = new THREE.Mesh(windowGeom, windowMat);
            window1.position.set(0, 1.4, -0.5);
            carGroup.add(window1);
            const window2 = new THREE.Mesh(windowGeom, windowMat);
            window2.position.set(0, 1.4, 0.8);
            carGroup.add(window2);

            // Wheels
            const wheelGeom = new THREE.CylinderGeometry(0.5, 0.5, 0.3, 16);
            const wheelMat = new THREE.MeshStandardMaterial({ color: 0x222222, metalness: 0.5, roughness: 0.8 });
            
            const wheels = [];
            const wheelPositions = [
                [-1, 0.5, -1.2],
                [1, 0.5, -1.2],
                [-1, 0.5, 1.2],
                [1, 0.5, 1.2]
            ];
            
            wheelPositions.forEach(pos => {
                const wheel = new THREE.Mesh(wheelGeom, wheelMat);
                wheel.rotation.z = Math.PI / 2;
                wheel.position.set(pos[0], pos[1], pos[2]);
                wheel.castShadow = true;
                carGroup.add(wheel);
                wheels.push(wheel);
            });

            // Headlights
            const lightGeom = new THREE.SphereGeometry(0.3, 8, 8);
            const lightMat = new THREE.MeshStandardMaterial({ color: 0xffff99, emissive: 0xffff00, emissiveIntensity: 0.8 });
            const light1 = new THREE.Mesh(lightGeom, lightMat);
            light1.position.set(-0.7, 1.0, -2.2);
            carGroup.add(light1);
            const light2 = new THREE.Mesh(lightGeom, lightMat);
            light2.position.set(0.7, 1.0, -2.2);
            carGroup.add(light2);

            carGroup.position.copy(playerCar.position);
            scene.add(carGroup);
            playerCar.mesh = carGroup;
            playerCar.wheels = wheels;

            return carGroup;
        }

        // ========== WORLD GENERATION ==========
        function createWorld() {
            // Ground plane (city block)
            const groundGeom = new THREE.PlaneGeometry(2000, 2000);
            const groundMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
            const ground = new THREE.Mesh(groundGeom, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Bank Building
            const bankGeom = new THREE.BoxGeometry(20, 15, 20);
            const bankMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.4, roughness: 0.6 });
            const bank = new THREE.Mesh(bankGeom, bankMat);
            bank.position.set(-50, 7.5, -100);
            bank.castShadow = true;
            bank.receiveShadow = true;
            scene.add(bank);

            // Bank entrance door
            const doorGeom = new THREE.BoxGeometry(5, 6, 0.5);
            const doorMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const door = new THREE.Mesh(doorGeom, doorMat);
            door.position.set(-50, 3, -9.5);
            door.castShadow = true;
            scene.add(door);

            // Road (highway)
            const roadGeom = new THREE.PlaneGeometry(50, 3000);
            const roadMat = new THREE.MeshStandardMaterial({ color: 0x222222, map: null });
            const road = new THREE.Mesh(roadGeom, roadMat);
            road.rotation.x = -Math.PI / 2;
            road.position.y = 0.01;
            road.position.z = 500;
            road.receiveShadow = true;
            scene.add(road);

            // Road lane markings
            for (let i = 0; i < 100; i++) {
                const lineGeom = new THREE.PlaneGeometry(1, 30);
                const lineMat = new THREE.MeshStandardMaterial({ color: 0xffff00 });
                const line = new THREE.Mesh(lineGeom, lineMat);
                line.rotation.x = -Math.PI / 2;
                line.position.set(-15 + i * 3, 0.02, 500 + i * 50 - 2500);
                scene.add(line);
            }

            // City buildings
            for (let i = 0; i < 15; i++) {
                const buildingHeight = 20 + Math.random() * 40;
                const buildingGeom = new THREE.BoxGeometry(30 + Math.random() * 40, buildingHeight, 30 + Math.random() * 40);
                const buildingMat = new THREE.MeshStandardMaterial({ color: 0xaaaaaa + Math.floor(Math.random() * 0x555555) });
                const building = new THREE.Mesh(buildingGeom, buildingMat);
                building.position.set(-400 + i * 80, buildingHeight / 2, -300 + Math.random() * 200);
                building.castShadow = true;
                building.receiveShadow = true;
                scene.add(building);
            }

            // Street lights
            for (let i = 0; i < 50; i++) {
                const poleGeom = new THREE.CylinderGeometry(0.3, 0.3, 10, 8);
                const poleMat = new THREE.MeshStandardMaterial({ color: 0x444444 });
                const pole = new THREE.Mesh(poleGeom, poleMat);
                pole.position.set(-200 + i * 30, 5, -200 + Math.sin(i) * 100);
                scene.add(pole);

                const lightGeom = new THREE.SphereGeometry(1, 8, 8);
                const lightMat = new THREE.MeshStandardMaterial({ color: 0xffff99, emissive: 0xffff00 });
                const light = new THREE.Mesh(lightGeom, lightMat);
                light.position.copy(pole.position);
                light.position.y = 10;
                scene.add(light);
            }

            // Traffic lights at intersections
            for (let i = 0; i < 10; i++) {
                const tfBaseGeom = new THREE.BoxGeometry(0.5, 3, 0.5);
                const tfBaseMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
                const tfBase = new THREE.Mesh(tfBaseGeom, tfBaseMat);
                tfBase.position.set(-200 + i * 50, 1.5, 0);
                scene.add(tfBase);
            }
        }

        // ========== CINEMATIC SEQUENCE ==========
        function playBankEscapeCinematic() {
            gameState.missionPhase = 0;
            const cinematicDiv = document.getElementById('cinematic');
            const cinematicText = document.getElementById('cinematicText');
            
            let cinematicTime = 0;
            const cinematicDuration = 8000; // 8 seconds

            const cinematicLoop = () => {
                cinematicTime += 16;
                
                if (cinematicTime < 2000) {
                    cinematicText.innerHTML = "BANK ROBBERY IN PROGRESS...";
                } else if (cinematicTime < 4000) {
                    cinematicText.innerHTML = "SUSPECTS ESCAPING...";
                    playerCar.acceleration = 0.5;
                    gameState.isPlayerMoving = true;
                } else if (cinematicTime < 6000) {
                    cinematicText.innerHTML = "ENGINE STARTING...";
                } else if (cinematicTime < cinematicDuration) {
                    cinematicText.innerHTML = "GET TO THE HIGHWAY!";
                } else {
                    cinematicDiv.style.opacity = "0";
                    cinematicDiv.style.pointerEvents = "none";
                    gameState.missionPhase = 1;
                    gameState.wanted = 1;
                    return;
                }
                
                requestAnimationFrame(cinematicLoop);
            };

            requestAnimationFrame(cinematicLoop);
        }

        // ========== AI & TRAFFIC ==========
        class TrafficCar {
            constructor(x, z, isPolice = false) {
                this.position = new THREE.Vector3(x, 1, z);
                this.velocity = new THREE.Vector3(0, 0, 0);
                this.speed = 2 + Math.random() * 3;
                this.rotation = Math.random() * Math.PI * 2;
                this.isPolice = isPolice;
                this.mesh = this.createMesh();
                this.health = 100;
            }

            createMesh() {
                const carGroup = new THREE.Group();
                const bodyGeom = new THREE.BoxGeometry(1.5, 0.8, 3);
                const color = this.isPolice ? 0x0000ff : 0xffffff;
                const bodyMat = new THREE.MeshStandardMaterial({ color });
                const body = new THREE.Mesh(bodyGeom, bodyMat);
                body.position.y = 0.4;
                body.castShadow = true;
                carGroup.add(body);

                const wheelGeom = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 8);
                const wheelMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
                [-0.6, 0.6].forEach(x => {
                    [-0.8, 0.8].forEach(z => {
                        const wheel = new THREE.Mesh(wheelGeom, wheelMat);
                        wheel.rotation.z = Math.PI / 2;
                        wheel.position.set(x, 0.3, z);
                        carGroup.add(wheel);
                    });
                });

                carGroup.position.copy(this.position);
                carGroup.rotation.y = this.rotation;
                scene.add(carGroup);
                return carGroup;
            }

            update() {
                this.position.x += Math.cos(this.rotation) * this.speed * 0.016;
                this.position.z += Math.sin(this.rotation) * this.speed * 0.016;

                // Basic avoidance
                if (Math.random() < 0.05) {
                    this.rotation += (Math.random() - 0.5) * 0.1;
                }

                // Wrap around
                if (Math.abs(this.position.x) > 1000 || Math.abs(this.position.z) > 2000) {
                    this.position.set(Math.random() * 200 - 100, 1, Math.random() * 2000 - 1000);
                }

                this.mesh.position.copy(this.position);
                this.mesh.rotation.y = this.rotation;
            }
        }

        function spawnTraffic() {
            for (let i = 0; i < 50; i++) {
                const x = Math.random() * 400 - 200;
                const z = Math.random() * 2000 - 1000;
                gameState.traffic.push(new TrafficCar(x, z, false));
            }
        }

        function spawnPolice() {
            if (gameState.wanted > 0 && gameState.policePresence.length < gameState.wanted * 2) {
                const x = playerCar.position.x + (Math.random() - 0.5) * 200;
                const z = playerCar.position.z + (Math.random() - 0.5) * 200;
                gameState.policePresence.push(new TrafficCar(x, z, true));
            }
        }

        // ========== INPUT HANDLING ==========
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (key === 'w' || e.key === 'ArrowUp') gameState.input.w = true;
            if (key === 's' || e.key === 'ArrowDown') gameState.input.s = true;
            if (key === 'a' || e.key === 'ArrowLeft') gameState.input.a = true;
            if (key === 'd' || e.key === 'ArrowRight') gameState.input.d = true;
            if (key === '1') gameState.cameraMode = 0;
            if (key === '2') gameState.cameraMode = 1;
            if (key === '3') gameState.cameraMode = 2;
            if (key === '4') gameState.cameraMode = 3;
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (key === 'w' || e.key === 'ArrowUp') gameState.input.w = false;
            if (key === 's' || e.key === 'ArrowDown') gameState.input.s = false;
            if (key === 'a' || e.key === 'ArrowLeft') gameState.input.a = false;
            if (key === 'd' || e.key === 'ArrowRight') gameState.input.d = false;
        });

        // ========== GAME PHYSICS ==========
        function updatePlayerCar() {
            // Acceleration
            if (gameState.input.w) {
                gameState.speed = Math.min(gameState.speed + 3, gameState.maxSpeed);
            } else {
                gameState.speed = Math.max(gameState.speed - 2, 0);
            }

            if (gameState.input.s) {
                gameState.speed = Math.max(gameState.speed - 5, -50);
            }

            // Steering
            if (gameState.input.a) playerCar.rotation -= 0.05;
            if (gameState.input.d) playerCar.rotation += 0.05;

            // Update position
            playerCar.position.x += Math.cos(playerCar.rotation) * gameState.speed * 0.016;
            playerCar.position.z += Math.sin(playerCar.rotation) * gameState.speed * 0.016;

            // Fuel consumption
            gameState.fuel -= (Math.abs(gameState.speed) / 260) * 0.01;
            gameState.fuel = Math.max(gameState.fuel, 0);

            // Fuel refuel at gas station (simple proximity check)
            if (gameState.fuel < 10) {
                gameState.fuel = 100;
            }

            // Update mesh
            playerCar.mesh.position.copy(playerCar.position);
            playerCar.mesh.rotation.y = playerCar.rotation;

            // Wheel rotation
            playerCar.wheelRotation += gameState.speed * 0.01;
            if (playerCar.wheels) {
                playerCar.wheels.forEach(wheel => {
                    wheel.rotation.x = playerCar.wheelRotation;
                });
            }
        }

        function updateTraffic() {
            gameState.traffic.forEach(car => car.update());
            gameState.policePresence.forEach(car => {
                car.update();
                // Police chasing behavior
                const dx = playerCar.position.x - car.position.x;
                const dz = playerCar.position.z - car.position.z;
                const distance = Math.sqrt(dx * dx + dz * dz);
                if (distance < 200) {
                    car.rotation = Math.atan2(dz, dx);
                    car.speed = 5;
                }
            });
        }

        function updateCamera() {
            const cameraDistance = 15;
            const cameraHeight = 6;
            const lookAheadDistance = 20;

            if (gameState.cameraMode === 0) {
                // Cockpit view
                camera.position.set(
                    playerCar.position.x + Math.cos(playerCar.rotation) * 0.5,
                    playerCar.position.y + 1.2,
                    playerCar.position.z + Math.sin(playerCar.rotation) * 0.5
                );
            } else if (gameState.cameraMode === 1) {
                // Hood view
                camera.position.set(
                    playerCar.position.x + Math.cos(playerCar.rotation) * 2,
                    playerCar.position.y + 1.5,
                    playerCar.position.z + Math.sin(playerCar.rotation) * 2
                );
            } else if (gameState.cameraMode === 2) {
                // Chase view
                camera.position.set(
                    playerCar.position.x - Math.cos(playerCar.rotation) * cameraDistance,
                    playerCar.position.y + cameraHeight,
                    playerCar.position.z - Math.sin(playerCar.rotation) * cameraDistance
                );
            } else if (gameState.cameraMode === 3) {
                // Cinematic far view
                camera.position.set(
                    playerCar.position.x + 50,
                    playerCar.position.y + 30,
                    playerCar.position.z + 50
                );
            }

            const lookAt = new THREE.Vector3(
                playerCar.position.x + Math.cos(playerCar.rotation) * lookAheadDistance,
                playerCar.position.y + 1,
                playerCar.position.z + Math.sin(playerCar.rotation) * lookAheadDistance
            );
            camera.lookAt(lookAt);
        }

        // ========== COLLISION DETECTION ==========
        function checkCollisions() {
            gameState.traffic.forEach(car => {
                const dx = playerCar.position.x - car.position.x;
                const dz = playerCar.position.z - car.position.z;
                const distance = Math.sqrt(dx * dx + dz * dz);

                if (distance < 3) {
                    gameState.health -= 5;
                    gameState.speed *= 0.8;
                    if (car.isPolice) gameState.wanted = Math.min(gameState.wanted + 1, 5);
                }
            });

            gameState.health = Math.max(gameState.health, 0);
            if (gameState.health <= 0) {
                alert("Game Over!");
                location.reload();
            }
        }

        // ========== WANTED SYSTEM ==========
        function updateWantedSystem() {
            if (gameState.wanted > 0) {
                spawnPolice();
            }

            // Increase wanted for speeding near bank
            if (gameState.missionPhase === 1) {
                if (gameState.speed > 100) gameState.wanted = Math.max(gameState.wanted, 2);
            }
        }

        // ========== HUD UPDATE ==========
        function updateHUD() {
            document.getElementById('speed').textContent = Math.floor(gameState.speed);
            document.getElementById('health').textContent = Math.floor(gameState.health);
            document.getElementById('fuel').textContent = Math.floor(gameState.fuel);
            document.getElementById('wanted').textContent = '⭐'.repeat(gameState.wanted);

            let missionText = "";
            if (gameState.missionPhase === 0) {
                missionText = "CINEMATIC: Bank Escape Starting...";
            } else if (gameState.missionPhase === 1) {
                missionText = "ESCAPE: Get away from bank area!";
            } else if (gameState.missionPhase === 2) {
                missionText = "HIGHWAY: Reach the highway!";
            } else {
                missionText = "FREE ROAM: Evade police!";
            }

            document.getElementById('missionText').innerHTML = missionText;
        }

        // ========== SAVE/LOAD SYSTEM ==========
        function saveGame() {
            const saveData = {
                wanted: gameState.wanted,
                health: gameState.health,
                missionPhase: gameState.missionPhase
            };
            localStorage.setItem('bankEscapeGame', JSON.stringify(saveData));
        }

        function loadGame() {
            const saved = localStorage.getItem('bankEscapeGame');
            if (saved) {
                const data = JSON.parse(saved);
                gameState.wanted = data.wanted;
                gameState.health = data.health;
                gameState.missionPhase = data.missionPhase;
                return true;
            }
            return false;
        }

        // ========== MAIN LOOP ==========
        function animate() {
            requestAnimationFrame(animate);

            if (gameState.missionPhase === 0) {
                // Cinematic playing
            } else {
                updatePlayerCar();
                updateTraffic();
                updateCamera();
                checkCollisions();
                updateWantedSystem();
                saveGame();
            }

            updateHUD();
            renderer.render(scene, camera);
        }

        // ========== INITIALIZATION ==========
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        createPlayerCar();
        createWorld();
        spawnTraffic();
        
        if (!loadGame()) {
            playBankEscapeCinematic();
        } else {
            gameState.missionPhase = 2;
        }

        animate();
    </script>
</body>
</html>